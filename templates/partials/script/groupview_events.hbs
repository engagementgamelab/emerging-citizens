{{!< default}}
{{!-- 
/**
 * Emerging Citizens
 * Developed by Engagement Lab, 2016
 * ==============
 * 
 * Script includes partial for MODERATOR socket.io events
 * ==========
 */
--}}			

var socketEvents = function(eventId, eventData) {
		
	var currentPlayers = [];
    var clockInterval;
    
    switch (eventId) {

        case 'connect':

			   // Connected, let's sign-up for to receive messages for this room
               $('#startGameForm').css('padding', '1%');
               
			   socket.emit('room', emitData('moderator'));
               
            break;

        case 'players:update':

                var staticPlayers = $('.player-static');
			  	currentPlayers = _.pluck(eventData, 'username');
                console.log (eventData + " player name event data" + currentPlayers);

                // Allow to start?
                if(currentPlayers.length === 2)
                {
                    var startAnim = new TimelineLite();
                    startAnim.from($('#btn-start-game'), 1, {scale:0, autoAlpha: 0, ease:Elastic.easeOut})
                }

                _.each(currentPlayers, function(name, index) {

                    var nameFormatted = (name.length <= 15) ? name : name.substring(0, 15) + "...";

                    $(staticPlayers[index]).children('.icon').addClass('active');
                    $(staticPlayers[index]).children('.nameplate').addClass('active').text(nameFormatted);
                });

            break;

        case 'game:tutorial':
            
            $('#overlay').html(eventData).fadeIn();
            
            // Show countdown
            var secondsLeft = 8;
            var circle = new ProgressBar.Circle('#countdown', {
                color: '#fff',
                duration: 8000,
                easing: 'easeInOut',
                strokeWidth: 6,
                trailColor: '#f4f4f4',
                trailWidth: 0.8,
                fill: '#00c5c2',
                text: {
                    value: '8',
                    className: 'text',
                }
            });

            $('#countdown').click(function() {
                $('#overlay').fadeOut();
            });

            var tutorialCountdown = setInterval(function() {
                secondsLeft--;

                $('#countdown .text').text(secondsLeft);

                // End countdown and show arrow to continue
                if(secondsLeft == 0) {
                    clearInterval(tutorialCountdown);

                    var icon = $('#continue .icon').detach();
                    $('#countdown .text').empty();
                    icon.appendTo($('#countdown .text'));
                    
                    var continueAnim = new TimelineMax({ paused:true });
                    continueAnim
                    .from(icon, 1.5, {scale: 0, autoAlpha: 0, ease: Bounce.easeOut })
                    .from(icon, 1, {x: '+20', repeat: -1, yoyo: true, ease: Expo.easeOut });
                    // .to($('#countdown'), 1, {scale: 2, ease: Bounce.easeOut })
                    // .from($('#countdown'), 1, {scale: 2, ease: Bounce.easeOut, delay: 1 });

                    continueAnim.play();
                }
            }, 1000);

            circle.animate(1);

            break;

        case 'game:start':
            
            $('#gameContent').html(eventData.html);


            {{#ifeq gameType "wikigeeks"}}

                var countdownText =  $('#countdown #text');
                secondsLeft = eventData.timeLimit * 60;
                console.log ("game:start");
                console.log (secondsLeft, "seconds left");

                var topicCountdown = setInterval(function() {
                    secondsLeft--;

                    let displaySeconds = (secondsLeft < 10) ? '0'+secondsLeft : secondsLeft;

                    TweenLite.to(countdownText, .1, { scale: 0 });
                    $(countdownText).text('0:' + displaySeconds);
                    TweenLite.from(countdownText, .1, { scale: 0 });

                    // End countdown
                    if(secondsLeft == 0)
                        clearInterval(topicCountdown);
            
                }, 1000);

            {{/ifeq}}

            break;
            
        case 'game:countdown':


        {{#ifeq gameType "htyi"}}
            console.log ("htyi countdown");
                var secondsLeft = eventData;
                var timeFactor = 360 / secondsLeft;
                var clockHand = $('#clock-hand');

                if(clockInterval !== undefined)
                    clearInterval(clockInterval);
                    
                clockInterval = setInterval(function() {

                    function clockTick() {
                        clockHand.css({
                            transform:'rotateZ('+ -(timeFactor*secondsLeft) + 'deg)'
                        });
                        secondsLeft--;
                    }

                    clockTick();

                    if(secondsLeft === 0)
                        clearInterval(clockInterval);
                }, 1000);


            break;  
        {{/ifeq}}  

        {{#ifeq gameType "wikigeeks"}}
        console.log ("wikigeeks countdown");
                var countdownText =  $('#countdown #text');
                var secondsLeft = eventData;
                console.log (secondsLeft, "seconds left");

                var topicCountdown = setInterval(function() {
                    secondsLeft--;

                    let displaySeconds = (secondsLeft < 10) ? '0'+secondsLeft : secondsLeft;

                    TweenLite.to(countdownText, .1, { scale: 0 });
                    $(countdownText).text('0:' + displaySeconds);
                    TweenLite.from(countdownText, .1, { scale: 0 });

                    // End countdown
                    if(secondsLeft == 0)
                        clearInterval(topicCountdown);
            
                }, 1000);

            break;
        {{/ifeq}}

        {{!-- break; --}}

        case 'game:end':

        {{#ifeq gameType "htyi"}}
          
            case 'hashtag:submitted':
            case 'hashtags:received':

                $('#gameContent').html(eventData);
                
                currentHashtags = _.pluck(eventData, 'hashtag-submissions');

                //instantiate a TimelineLite for hashtags received animation
                var hashtagsVoteAnim = new TimelineLite({ paused:true });
                $('#hashtag-submissions-prompt').show();

                hashtagsVoteAnim.from($('#hashtag-submissions-prompt'), 1, { y: -200, autoAlpha: 0, ease:Elastic.easeOut })
                .staggerFrom($('#hashtag-submissions .leftmost .hashtag'), 1, {xPercent:-100, autoAlpha:0, ease:Elastic.easeOut}, .5)
                .staggerFrom($('#hashtag-submissions .left .hashtag'), 1, {yPercent:100, autoAlpha:0, ease:Elastic.easeOut}, .5)
                .staggerFrom($('#hashtag-submissions .right .hashtag'), 1, {yPercent:100, autoAlpha:0, ease:Elastic.easeOut}, .5)
                .staggerFrom($('#hashtag-submissions .rightmost .hashtag'), 1, {xPercent:100, autoAlpha:0, ease:Elastic.easeOut, delay: .3}, .5);

                hashtagsVoteAnim.play();

                break;

        {{/ifeq}}

        case 'hashtags:results':

            {{> script/htyi_results debug=debug}}
            
            break;

        {{#ifeq gameType "wikigeeks"}}
            case 'topic:info':
            
                $('#gameContent').html(eventData);

            case 'topic:results':
                
                $('#gameContent').html(eventData);

                var scoreAnim = new TimelineLite({paused: true});

                scoreAnim.from($('#results'), 1, {autoAlpha:0, scale: 0, ease:Bounce.easeOut}, 'resultsShow')
                .to($('#results'), 1, {autoAlpha:0, scale: 0, ease:Bounce.easeOut}, 'resultsHide', 'resultsShow+=5.0')
                .from($('#scoring'), 1, {autoAlpha:0, scale: 0, ease:Bounce.easeOut}, 'scoringShow', 'resultsHide+=1.2')
                .to($('#scoring'), 1, {autoAlpha:0, scale: 0, ease:Bounce.easeOut}, 'scoringHide', 'scoringShow+=5');

                scoreAnim.play();

                break;
        {{/ifeq}}

        default:

            console.error('No handler found for event "' + eventId + '"');

            break;

    }
    
};