{{!< default}}
{{!-- 
/**
 * Emerging Citizens
 * Developed by Engagement Lab, 2016
 * ==============
 * 
 * Script includes partial for individual sections
 * ==========
 */
--}}

<script type="text/javascript">
	localStorage.debug = '*';

	$(document).ready(function() {
			
    socket = io();
		
		{{!-- INDEX Template Script --}}
		{{#ifeq section 'home'}}
		var gameCode = '{{game.accessCode}}';

   	socket.on('connect', function() {
		   // Connected, let's sign-up for to receive messages for this room
		   socket.emit('room', emitData('player'));
		});

    socket.on('players:update', function(msg) {
    	$('.login-box').hide();
	    $('#team').html(_.pluck(msg, 'username').join('<br />'));
 	  });

    socket.on('game:start', function(html) {
	    $('#gameContent').html(html);
 	  });
    socket.on('game:end', function(html) {
	    console.log('game was ended');
 	  });
    socket.on('game:notfound', function(html) {
	    console.log('game not found!');
	    $('#error-box').text('game not found!');
	    $('#error-box').show();
 	  });

    socket.on('hashtags:received', function(msg) {
	  	console.log(msg);
	  	// $('#team').append('<br />User ' + msg.user + ' sent in hashtag #' + msg.hashtag);
 	  });

		// $('#btn_submit').click(function(e) {
		//   socket.emit('login:submit', emitData({ 
		// 																			  username: $('#player_name').val()
		// 																			}
		// 																		));
		// });

		$(document).on('click', '.input-box :submit', function() {
			var event = $(this).data().event;
			var pkg = $(this).data().package;

			if($.isPlainObject(pkg)) {
				$.each(Object.keys(pkg), function( key, value ) {
				  pkg[value] = $('#' + pkg[value].toString()).val();
				});
			}
			else
				pkg = $('#' + pkg).val()
			
			socket.emit(event, emitData(pkg));
		});

		function tweet() {

			$('#btn_submit').click(function(e) {
			  socket.emit('hashtagSubmitted', emitData($('#tweet_input').val()));
			});

		}
		{{/ifeq}}

		{{#ifeq section 'moderator'}}

		$('#btn_submit').click(function(e) {
			var data = $(":input").serializeArray();
		  $.post( 
		  	"/api/create/",
				data,
				function( data ) {
				  window.location = data;
				}
			);
		});

		{{/ifeq}}

		{{#ifeq section 'moderator/monitor'}}
		
		var gameCode = '{{game.accessCode}}-moderator';
		var currentPlayers = [];

   	socket.on('connect', function() {
		   // Connected, let's sign-up for to receive messages for this room
		   socket.emit('room', emitData('moderator'));
		});

    socket.on('players:update', function(players) {
	  	currentPlayers = players;
	    $('#gameContent').html(_.values(players).join('joined. <br />'));
 	  });

    socket.on('game:start', function(html) {
	    $('#gameContent').html(html);
 	  });

    socket.on('hashtags:received', function(msg) {
	  	var html = _.map(msg, function(hashtag, user){ return currentPlayers[user] + ': ' + hashtag; });
	    $('#gameContent').html(html);
 	  });

    socket.on('player:login', function(msg) {
	  	console.log(msg)
	    // $('#team').html(msg.join('<br />'));
 	  });

    socket.on('hashtags:received', function(msg) {
	  	console.log(msg);
	  	// $('#team').append('<br />User ' + msg.user + ' sent in hashtag #' + msg.hashtag);
 	  });
	
		{{/ifeq}}
		
		function emitData(data) {
			return { gameId: gameCode, msgData: data };
		}
		
});

</script>